# AI对话助手设计文档（v1.1）

## 1. 项目概述

**项目名称**：AI对话助手（AI Chat Assistant）  
**用途**：一个全栈AI对话框架，提供类Gemini/Grok的聊天体验，支持上下文记忆、Markdown渲染、附件处理，并具备可扩展的Agent路由机制。核心是“智能主管Agent + 可插拔专业Agent”的架构，主Agent负责意图识别与任务分配，专业Agent负责具体垂直任务执行。

**核心特性**
- 前端：现代Web聊天界面，支持Markdown渲染、深色/浅色主题切换
- 后端：对话历史管理、上下文记忆、附件临时上传处理、意图识别路由、可自定义接入多种专业Agent
- 扩展性：不依赖LangChain/CrewAI等框架，通过原生LLM函数调用或自定义路由表实现Agent调度

**变更记录（v1.1）**
- 前端技术选型升级为 Next.js 14（App Router），替换原有纯 React + Vite 方案
- 受益：SSR/SSG 支持、更优的路由管理、内置优化、next-themes 完美支持深浅模式切换

## 2. 功能需求

（与 v1.0 一致，无变更）

### 2.1 前端功能
- 布局：左侧侧边栏（历史记录）、中间主区域（对话消息流），参考Gemini + Grok
- 消息渲染：完整Markdown（代码高亮、表格、LaTeX等）+ 流式输出
- 主题切换：深色/浅色模式（持久化）
- 附件上传：支持图片、视频、Excel、PDF，拖拽上传 + 预览
- 交互：新建/删除对话、输入框支持 Enter 发送

### 2.2 后端功能
（与 v1.0 一致）

## 3. 系统架构

（与 v1.0 一致）

```
前端 (Next.js)  <--WebSocket/SSE + REST-->  后端 (FastAPI)
```

## 4. 技术栈（更新）

**前端**
- Next.js 14（App Router） + TypeScript
- UI库：Tailwind CSS + shadcn/ui（组件可复用、易自定义主题）
- Markdown渲染：react-markdown + remark-gfm + rehype-raw + rehype-highlight（代码高亮）
- 状态管理：Zustand（全局状态） + React Context（局部）
- 主题切换：next-themes（内置深浅模式支持，自动跟随系统）
- 流式响应：Server-Sent Events (SSE) 或 WebSocket 客户端
- 其他：next/font 优化字体、Image 组件优化图片

**后端**（无变更）
- FastAPI（异步、高性能）
- 配置管理：pydantic-settings
- 数据库：MongoDB（推荐）或 SQLite
- LLM调用：通用封装，支持多模型
- 附件处理：pandas / openpyxl / PyPDF2 / pdfplumber
- 日志：structlog

**禁止技术**：LangChain、CrewAI、LlamaIndex 等任何类似Agent框架

## 5. API 接口概览（后端）

（与 v1.0 一致）

## 6. 开发计划（更新建议）

1. 搭建 FastAPI 基础结构 + MongoDB 对话存储
2. 实现主Agent意图识别与路由
3. **Next.js 前端基础布局（app router） + Markdown 渲染 + 主题切换**
4. 接入 SSE / WebSocket 流式聊天
5. 实现附件上传与temp清理
6. 开发示例专业Agent（金融分析）
7. UI细节优化与响应式适配
8. 测试与 Docker 部署

## 项目结构

```text
ai_chat_assistant/
├── frontend/                     # Next.js 前端项目
│   ├── app/                      # App Router 路由
│   │   ├── (chat)/               # 聊天相关路由组
│   │   │   ├── conversation/
│   │   │   │   └── [id]/page.tsx # 单个对话页面
│   │   │   ├── layout.tsx        # 聊天布局（侧边栏 + 主区）
│   │   │   └── page.tsx          # 默认聊天页（新建对话）
│   │   ├── globals.css
│   │   ├── layout.tsx            # 根布局（ThemeProvider等）
│   │   └── page.tsx              # 首页（可选）
│   ├── components/               # 可复用组件
│   │   ├── chat/                 # ChatMessage, MessageList, InputBar 等
│   │   ├── sidebar/              # ConversationList, NewChatButton 等
│   │   ├── ui/                   # shadcn/ui 组件
│   │   └── ThemeToggle.tsx
│   ├── lib/                      # 工具函数
│   │   ├── api.ts                # API 客户端（fetch）
│   │   ├── websocket.ts          # WebSocket/SSE 工具
│   │   └── utils.ts
│   ├── stores/                   # Zustand stores
│   │   └── useConversationStore.ts
│   ├── public/                   # 静态资源
│   ├── next.config.js
│   ├── tailwind.config.ts
│   ├── tsconfig.json
│   ├── package.json
│   └── .env.local                # 前端环境变量
│
├── backend/                      # FastAPI 后端代码（与 v1.0 一致）
│   ├── src/
│   │   ├── __init__.py
│   │   ├── main.py
│   │   ├── config.py
│   │   ├── api/
│   │   │   ├── chat.py
│   │   │   ├── conversations.py
│   │   │   └── upload.py
│   │   ├── core/
│   │   │   ├── supervisor.py
│   │   │   ├── llm_client.py
│   │   │   └── streaming.py
│   │   ├── agents/
│   │   │   ├── __init__.py
│   │   │   ├── base.py
│   │   │   └── financial.py
│   │   ├── services/
│   │   │   ├── attachment.py
│   │   │   └── document.py
│   │   ├── models/
│   │   │   └── conversation.py
│   │   ├── db/
│   │   │   └── mongo.py
│   │   └── utils/
│   │       ├── logger.py
│   │       └── temp_manager.py
│   ├── temp/                     # 临时上传目录（.gitignore）
│   ├── requirements.txt
│   ├── pyproject.toml
│   └── .env.example
│
├── docs/
│   └── v1.1.md                   # 本文档
├── docker-compose.yml            # 前后端 + MongoDB 一键部署
├── .gitignore
└── README.md
```