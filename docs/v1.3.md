# AI对话助手设计文档（v1.3）

## 1. 项目概述

**项目名称**：AI对话助手（AI Chat Assistant）  
**用途**：一个全栈AI对话框架，提供类Gemini/Grok的聊天体验，支持上下文记忆、Markdown渲染、附件处理、可扩展Agent路由，同时新增完整用户认证、注册、订阅体系与后台管理平台，确保多租户隔离与高安全性。

**核心特性**（v1.3 新增/强化）
- 用户认证体系：登录、注册、图形验证码防暴力破解
- 多会员级别：普通、黄金、钻石（不同标识展示）
- 对话历史按用户UUID完全隔离，防止平行/垂直越权
- 后台管理平台：仅管理员可访问，进行用户管理、订阅调整
- 安全优先：前后端双重输入过滤、防SQL注入（虽使用MongoDB，仍防范NoSQL注入）、XSS防护、密码强哈希存储、UUID防遍历

**变更记录（v1.3）**
- 新增用户注册、登录（带图形验证码）
- 新增订阅系统（普通/黄金/钻石会员）
- 新增管理员后台管理平台
- 强化安全机制（密码哈希、输入过滤、权限控制、UUID用户ID）
- 对话历史与所有数据按用户隔离

## 2. 功能需求

### 2.1 前端功能（新增/调整）
- **认证页面**
  - 登录页：用户名、密码、图形验证码输入，提交后跳转聊天主界面
  - 注册页：用户名（严格过滤）、密码（≥8位，复杂性要求）、确认密码、图形验证码
  - 未登录状态自动跳转登录页
- **用户标识展示**
  - 侧边栏/头像区域显示会员级别徽章（普通/黄金/钻石图标+文字）
- **后台管理平台**
  - 独立路由 `/admin`，仅管理员可访问
  - 用户列表（搜索、分页）、查看/编辑用户订阅级别、封禁/解禁用户
- **安全交互**
  - 所有表单前后端校验，特殊字符过滤提示
  - 登录失败显示验证码错误或账号密码错误（不区分以防枚举）

### 2.2 后端功能（新增/调整）
- **用户认证**
  - 注册：用户名唯一、严格正则过滤（仅允许字母数字下划线），密码复杂度校验，后端使用**argon2**哈希存储（禁止明文）
  - 登录：验证用户名+密码+验证码，成功返回JWT token
  - 图形验证码：接口生成图片+文字，session或redis暂存验证码
- **权限控制**
  - 用户ID使用UUID4，防止ID遍历
  - 所有API校验JWT，提取user_id，确保操作仅限本人数据（防平行越权）
  - 角色字段：user / admin，管理员接口额外校验角色（防垂直越权）
- **订阅系统**
  - 用户表包含 subscription_level: "free" | "gold" | "diamond"
  - 会员级别影响：UI标识展示、未来可扩展功能限流/专属Agent
- **对话管理调整**
  - 所有对话记录绑定user_id，实现完全环境隔离
- **后台管理**
  - 管理员专用API：列出用户、修改订阅级别、禁用账号
- **安全措施**
  - 输入过滤：前后端均使用白名单正则，阻止<>"'&等XSS/NoSQL注入字符
  - 密码存储：Argon2id哈希（高安全）
  - 验证码防暴力：失败次数限制+IP限流（可选redis）
  - 日志记录敏感操作

## 3. 系统架构

```
前端 (Next.js) <-- REST + WebSocket/SSE --> 后端 (FastAPI)
                                           |
                                           ├── Auth模块 (JWT + Argon2 + CAPTCHA)
                                           ├── 用户/订阅管理
                                           ├── 管理员路由 (角色校验)
                                           ├── 主Agent + 专业Agent
                                           ├── 对话服务 (按user_id隔离)
                                           └── 数据库 (MongoDB: users + conversations)
```

## 4. 技术栈（更新）

**前端**（无重大变更）
- Next.js 14（App Router） + TypeScript
- UI库：Tailwind CSS + shadcn/ui
- 认证状态：Zustand全局存储JWT + 用户信息
- 验证码显示：简单<img>加载后端生成图片

**后端**（新增安全相关）
- FastAPI
- 认证：**PyJWT** + **passlib[argon2]**（密码哈希）
- 验证码：**captcha**库生成图片
- 输入校验：Pydantic严格模型 + 自定义validator（正则过滤）
- 限流/缓存：可选**slowapi**或redis
- 数据库：MongoDB（users集合、conversations集合，user_id为UUID）

**禁止技术**：LangChain、CrewAI等任何类似Agent框架

## 5. API 接口概览（新增/调整）

| 方法   | 路径                        | 功能                          | 权限          |
|--------|-----------------------------|-------------------------------|---------------|
| POST   | /auth/register              | 用户注册（带验证码）          | 公开          |
| POST   | /auth/login                 | 用户登录（带验证码）          | 公开          |
| GET    | /auth/captcha               | 获取图形验证码图片            | 公开          |
| GET    | /conversations              | 获取当前用户对话列表          | 登录用户      |
| POST   | /conversations              | 新建对话                      | 登录用户      |
| POST   | /chat/{conv_id}             | 发送消息                      | 登录用户      |
| GET    | /admin/users                | 获取用户列表（分页搜索）      | 仅管理员      |
| PATCH  | /admin/users/{user_id}      | 修改用户订阅/状态             | 仅管理员      |

所有需登录接口通过`Authorization: Bearer <JWT>`校验

## 6. 开发计划（更新）

1. 后端添加Auth模块（注册、登录、JWT、验证码、Argon2哈希）
2. 用户表设计 + 订阅字段 + 管理员角色
3. 前端添加登录/注册页 + 验证码显示 + JWT存储
4. 对话API绑定user_id隔离 + 权限中间件
5. 后台管理平台页面与API
6. 安全测试（输入过滤、越权测试）
7. 会员标识UI展示
8. 完整测试与部署

## 项目结构

```text
ai_chat_assistant/
├── frontend/                     # Next.js 前端项目
│   ├── app/
│   │   ├── (auth)/               # 认证相关路由
│   │   │   ├── login/page.tsx    # 登录页
│   │   │   ├── register/page.tsx # 注册页
│   │   │   └── layout.tsx
│   │   ├── (chat)/               # 聊天主路由（登录保护）
│   │   │   ├── conversation/[id]/page.tsx
│   │   │   ├── layout.tsx        # 侧边栏 + 主区 + 会员徽章
│   │   │   └── page.tsx
│   │   ├── admin/                # 后台管理（管理员保护）
│   │   │   ├── users/page.tsx    # 用户管理列表
│   │   │   └── layout.tsx
│   │   ├── layout.tsx            # 根布局（ThemeProvider + AuthProvider）
│   │   └── page.tsx              # 登录前落地页
│   ├── components/
│   │   ├── auth/                 # LoginForm, RegisterForm, CaptchaImg
│   │   ├── chat/                 # 聊天组件
│   │   ├── admin/                # UserTable, SubscriptionEditor
│   │   ├── MembershipBadge.tsx   # 会员级别徽章
│   │   └── ui/                   # shadcn组件
│   ├── lib/
│   │   ├── api.ts                # 封装fetch（自动加JWT）
│   │   └── auth.ts               # 登录状态工具
│   ├── stores/
│   │   └── useAuthStore.ts       # JWT + 用户信息 + 会员级别
│   ├── public/
│   └── package.json
│
├── backend/                      # FastAPI 后端代码
│   ├── src/
│   │   ├── __init__.py
│   │   ├── main.py               # FastAPI app + 全局依赖
│   │   ├── config.py
│   │   ├── api/
│   │   │   ├── auth.py           # 注册、登录、验证码路由
│   │   │   ├── chat.py
│   │   │   ├── conversations.py
│   │   │   ├── upload.py
│   │   │   └── admin.py          # 管理员专用路由
│   │   ├── core/
│   │   │   ├── auth.py           # JWT工具、密码哈希、依赖注入
│   │   │   ├── dependencies.py   # 当前用户/管理员校验
│   │   │   ├── supervisor.py
│   │   │   ├── llm_client.py
│   │   │   └── captcha.py       # 验证码生成
│   │   ├── agents/
│   │   │   ├── base.py
│   │   │   └── financial.py
│   │   ├── services/
│   │   │   ├── attachment.py
│   │   │   └── document.py
│   │   ├── models/
│   │   │   ├── user.py           # 用户Pydantic模型（UUID + 订阅 + 角色）
│   │   │   └── conversation.py
│   │   ├── db/
│   │   │   └── mongo.py          # 用户/对话CRUD（user_id隔离）
│   │   └── utils/
│   │       ├── logger.py
│   │       ├── validators.py     # 输入过滤正则
│   │       └── temp_manager.py
│   ├── temp/
│   ├── requirements.txt          # 新增 passlib[argon2], python-jose[cryptography], captcha
│   ├── pyproject.toml
│   └── .env.example
│
├── docs/
│   └── v1.3.md                   # 本文档
├── docker-compose.yml            # 前后端 + MongoDB + Redis（可选限流）
├── .gitignore
└── README.md
```